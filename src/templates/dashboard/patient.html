{% extends "dashboard/base.html" %}

{% block header %}
<div style="display: flex; gap: 5px; align-items: center">
    <span>
      <div
        onclick="window.history.back()"
        style="display: grid; place-items: center; cursor: pointer"
      >
        <svg
          xmlns="http://www.w3.org/2000/svg"
          height="20px"
          viewBox="0 -960 960 960"
          width="20px"
          fill="var(--icon-fill)"
        >
          <path
            d="m313-440 224 224-57 56-320-320 320-320 57 56-224 224h487v80H313Z"
          />
        </svg>
      </div>
    </span>
Patient Details / 
  <span style="font-size: 12px">
    <a href="{% url 'dashboard:patients' %}" style="color: var(--text-color)">
      Patients
    </a>
     / Dashboard
  </span>
</div>
{% endblock %}

{% block title %}
  {{ patient.user.username }} | Patient Details
{% endblock %}

{% block links %}
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/themes/confetti.css">
{% endblock %}

{% block styles %}
<style>

  :root {
    --phq9: #A75DF7;
    --gad7: #F25C66;
    --asq: #0E9F98;
    --monitoring: #f4a261;
    --other: #e0a800;
  }


  .tab.selected span {
    color: var(--accent-color);
    font-weight: bold;
  }
  .tab {
    cursor: pointer;
    padding: 8px 20px;
    border-radius: 15px 15px 0 0;
    border-radius: 0;
  }
  .tab.selected {
    border: 1px solid var(--accent-color);
    border-bottom: 0;
  }
  .tab:hover {
    background-color: var(--accent-color-extra-faint);
  }

  .tab-content {
    background-color: var(--content-block-bg);
    color: var(--text-color);
    padding: 20px;
    border-radius: 0 0 10px 10px;
    height: 100%;
  }
  .tab-pane {
    max-height: 100%;
    overflow-y: auto;
  }

  #overview {
    display: flex;
    flex-direction: row;
    gap: 20px;
  }

  #generic-list {
    max-height: calc(100vh - 380px);
    overflow-y: auto;
    padding-right: 5px;
  }

  #generic-list::-webkit-scrollbar {
    width: 6px;
  }

  #chart-container {
    display: flex;
    justify-content: flex-start;
    align-items: center;
    width: 50%;
    height: 250px;
    max-width: 900px;
}

.tab-pane.active {
  display: flex;
  flex-direction: column;
}

.tab-pane.hide {
  display: none;
}

#overview.active {
  display: flex;
  flex-direction: row;
}

#overview.hide {
  display: none;
}

#export-data {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  margin-top: 20px;
  flex: 1;
}

.export-title {
  font-size: 16px;
  font-weight: 500;
  color: var(--text-color);
  margin-bottom: 10px;
}

.export-button {
  display: flex;
  gap: 10px;
  align-items: center;
  padding: 10px 15px;
  border-radius: 5px;
  background-color: var(--accent-color);
  color: var(--accent-invert);
  cursor: pointer;
}

.datepicker-container {
  display: flex;
  gap: 40px;
  align-items: center;
  margin-bottom: 15px;
}

.datepicker-container input {
  background-color: var(--content-block-bg);
  color: var(--text-color);
  border: 1px solid var(--accent-color-extra-faint);
}

/* Reduce input field size */
.datepicker {
  padding: 6px;
  font-size: 13px;
  border: 1px solid #ccc;
  border-radius: 4px;
  width: 150px; /* Adjust width */
}

/* Reduce Flatpickr calendar size */
.flatpickr-calendar {
  font-size: 12px !important; /* Reduce overall font size */
  scale: 0.9; /* Reduce calendar size */
}


@media (max-width: 1100px) {
  .datepicker-container {
    flex-direction: column;
    gap: 10px;
  }
}


</style>
{% endblock %}

{% block content %}
<div class="container">
  <div style="gap: 20px; margin-top: 20px; display: flex; flex-direction: row; gap: 20px; margin-top: 20px;">
    <div class="contact-info" style="background-color: var(--content-block-bg);
    color: var(--text-color); padding: 20px; border-radius: 10px; display: flex; flex-direction: column; font-size: 14px; width: 50%;">
      <div class="title" style="font-size: 18px; font-weight: 500; color: var(--text-color); margin-bottom: 20px;">
        Contact Details
      </div>
      <div>
        <div style="display: flex; gap: 20px; align-items: center;">
          <span>Username: </span>
          <span>{{ patient.user.username }}</span>
        </div>
        <div style="display: flex; gap: 20px; align-items: center;">
          <span>Email:</span>
          <span>{{ patient.user.email }}</span>
        </div>
        <div style="display: flex; gap: 20px; align-items: center;">
          <span>Phone:</span>
          <span style="display: flex; gap: 5px; align-items: center;">
            {{ patient.user.phone|default:"Not Provided" }}
            <!-- copy number -->
            {% if patient.user.phone %}
            <div
            style="display: grid; place-items: center; cursor: pointer"
            onclick="handleCopy(this)"
            data-clipboard-text="{{ patient.user.phone }}"
            >
            <i class="material-icons" style="font-size: 16px; color: var(--icon-fill)">content_copy</i>
          </div>
          {% endif %}
        </span>
        </div>
        <div style="display: flex; gap: 20px; align-items: center; font-size: 12px; color: var(--text-color-light); margin-top: 10px; justify-content: flex-end;">
          <span>Joined {{ patient.user.date_joined|date:"d M, Y" }}</span>
        </div>
      </div>
    </div>
    <div class="patient-stats" style="background-color: var(--content-block-bg);
    color: var(--text-color); padding: 20px; border-radius: 10px; display: flex; flex-direction: column; font-size: 14px; width: 50%;">
      <div class="title" style="font-size: 18px; font-weight: 500; color: var(--text-color); margin-bottom: 20px;">
        Patient Stats
      </div>
      <div style="display: flex; gap: 20px; align-items: center;">
        <span>
          Sessions: 
          <span>{{ sessions_obj.count }}</span>
        </span>
        {% if sessions_obj.count > 0 %}
        <span>
          Latest Session:
          <span>{{ sessions_obj.latest.timestamp|date:"d M, Y" }} ({{ sessions_obj.latest.get_status_display|lower }})</span>
        </span>
        {% endif %}
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; margin-top: 20px;">
        {% for assessment in assessments %}
        <div style="display: flex; align-items: center;">
          <span>
            {{ assessment.0 }}:
            <span>{{ assessment.1 }}</span>
          </span>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
  <div class="horizontal-tab" style="margin-top: 20px; background-color: var(--header-bg);
   color: var(--text-color); font-size: 14px; padding: 5px 10px 0 10px; border-bottom: 1px solid var(--accent-color);">
    <div class="tab-header" style="display: flex;">
      <div class="tab selected" data-tab="overview">
        <span>Overview</span>
      </div>
      <div class="tab" data-tab="sessions">
        <span>Sessions</span>
      </div>
      <div class="tab" data-tab="assessments">
        <span>Assessments</span>
      </div>
    </div>
  </div>

  <div class="tab-content">
    <div id="overview" class="tab-pane active">
      <div id="chart-container">
          <canvas id="assessmentChart"></canvas>
      </div>
  
      <div id="export-data">
          <div class="export-title">
            Generate Patient Report
            <span style="font-size: 12px; font-style: italic;">
              (PDF format)
            </span>
          </div>
  
          <div class="datepicker-container">
            <div style="display: flex; gap: 5px; align-items: center; position: relative;">
              <i class="material-icons" style="font-size: 20px; color: var(--accent-color); position: absolute; bottom: 8px; right: 105%; cursor: pointer;"
              onclick="handleCalendarClick('#from-date')">calendar_today</i>
              <div style="display: flex; flex-direction: column;">
                <span style="font-size: 12px; font-style: italic; color: var(--text-color-light)">from date</span>
                <input type="text" id="from-date" class="datepicker" placeholder="From Date">
              </div>
            </div>
            <div style="display: flex; gap: 5px; align-items: center; position: relative;">
              <i class="material-icons" style="font-size: 20px; color: var(--accent-color); position: absolute; bottom: 8px; right: 105%; cursor: pointer;"
              onclick="handleCalendarClick('#to-date')">calendar_today</i>
              <div style="display: flex; flex-direction: column;">
                <span style="font-size: 12px; font-style: italic; color: var(--text-color-light)">to date</span>
                <input type="text" id="to-date" class="datepicker" placeholder="To Date">
              </div>
            </div>
          </div>
  
          <div class="export-button" onclick="handleExport()">
              Generate
              <i class="material-icons" style="font-size: 20px; color: var(--accent-invert)">download</i>
          </div>
      </div>
  </div>
    <div id="sessions" class="tab-pane">
       <div id="generic-list">
      {% include "dashboard/components/queryset-list.html" with queryset=sessions_obj detail_url_name='chat:session-page' status_field="status" timestamp_field="timestamp" tags_field="assessments.all" tag_display_field="get_type_display" %}
      </div>
    </div>
    <div id="assessments" class="tab-pane">
       <div id="generic-list">
      {% include "dashboard/components/queryset-list.html" with queryset=assessments_obj detail_url_name='dashboard:assessment' name_field="patient.user.username" icon="assignment" status_field="status" timestamp_field="timestamp" completion_field="completed_at" type_field="type" username_field="patient.user.username" %}
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  let chartData = {};
  let lineChart;
  
  document.addEventListener("DOMContentLoaded", async function () {
      const response = await fetch("{% url 'dashboard:assessment-chart' patient.id %}");
      if (response.ok) {
          const data = await response.json();
          console.log(data);
          chartData = data;
          lineChart = drawChart(data);

          setDates(data.from_date, data.to_date);
      } else {
          const data = await response.json();
          console.log(data);
          const chartContainer = document.getElementById('chart-container');
          chartContainer.innerHTML = `<div style="display: grid; place-items: center; height: 100%; width: 100%; color: var(--text-color); font-size: 16px;">${data.error}</div>`;

          const exportData = document.getElementById('export-data');
          exportData.style.display = 'none';
      }
  });


const themeSwitcher = document.querySelector('.theme-switcher');
themeSwitcher.addEventListener('click', () => {
    if (lineChart) {
        lineChart.destroy();
    }
    lineChart = drawChart(chartData);
});
          
  function drawChart(data) {
      const ctx = document.getElementById('assessmentChart').getContext('2d');
      const ele = getComputedStyle(document.documentElement);
  
      return new Chart(ctx, {
          type: 'line',
          data: {
              labels: data.labels,
              datasets: data.datasets.map(dataset => ({
                  ...dataset,
                  spanGaps: true,
                  pointRadius: 5,
                  pointHoverRadius: 7,
                  tension: 0.4,
                  borderWidth: 1,
                  borderColor: ele.getPropertyValue(`--${dataset.label.toLowerCase()}`),
                  backgroundColor: ele.getPropertyValue(`--${dataset.label.toLowerCase()}`),
              }))
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              scales: {
                  x: { 
                      title: { 
                          display: true,
                          text: 'Date',
                          color: ele.getPropertyValue('--text-color')
                      },
                      ticks: {
                          color: ele.getPropertyValue('--text-color'),
                      },
                      grid: {
                          display: false,
                      },
                      border: {
                          color: ele.getPropertyValue('--text-color')
                      }
                  },
                  y: { 
                      title: { 
                          display: true,
                          text: 'Score',
                          color: ele.getPropertyValue('--text-color')
                      },
                      beginAtZero: true,
                      ticks: {
                          stepSize: 1,
                          callback: function(value) {
                              if (Number.isInteger(value)) {
                                  return value;
                              }
                          },
                          color: ele.getPropertyValue('--text-color')
                      },
                      grid: {
                          display: false,
                      },
                      border: {
                          color: ele.getPropertyValue('--text-color'),
                          display: true
                      }
                  }
              },
              plugins: {
                  legend: {
                      display: true,
                      labels: {
                          color: ele.getPropertyValue('--text-color')
                      }
                  }
              }
          }
      });
  }
  

</script>
<script>
  document.querySelector('.nav-item.patients').classList.add('selected');

  function handleCopy(el) {
    const text = el.getAttribute('data-clipboard-text');
    navigator.clipboard.writeText(text);

    const icon = el.querySelector('i');
    icon.textContent = 'done';
    icon.style.color = 'var(--accent-color)';
    setTimeout(() => {
      icon.textContent = 'content_copy';
      icon.style.color = 'var(--icon-fill)';
    }, 1000);
  }

  const tabs = document.querySelectorAll(".tab");
    const tabPanes = document.querySelectorAll(".tab-pane");
    
    tabs.forEach(tab => {
      tab.addEventListener("click", function() {
        // Remove 'selected' class from all tabs
        tabs.forEach(t => t.classList.remove("selected"));
        
        // Hide all tab panes
        tabPanes.forEach(pane => {
          pane.classList.add("hide");
          pane.classList.remove("active");
        });
        
        // Add 'selected' class to clicked tab
        this.classList.add("selected");
        
        // Show the corresponding tab content
        const target = this.getAttribute("data-tab");
        document.getElementById(target).classList.add("active");
        document.getElementById(target).classList.remove("hide");
      });
    });
</script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
  function setDates(fromDate, toDate) {
    flatpickr("#from-date", {
        enableTime: false,
        dateFormat: "Y-m-d",
        defaultDate: fromDate,
        minDate: fromDate,
        maxDate: toDate,
    });

    flatpickr("#to-date", {
        enableTime: false,
        dateFormat: "Y-m-d",
        defaultDate: toDate,
        minDate: fromDate,
        maxDate: toDate,
    });
  }

  function handleCalendarClick(selector) {
    const input = document.querySelector(selector);
    input._flatpickr.open();
  }

  // esc closes calendar
  document.addEventListener('keydown', function (event) {
    if (event.key === 'Escape') {
      const fromInput = document.getElementById('from-date');
      const toInput = document.getElementById('to-date');
      fromInput._flatpickr.close();
      toInput._flatpickr.close();
    }
  });


  function handleExport() {
    const exportButton = document.querySelector('.export-button');
    setButtonState(exportButton, true);

    const fromDate = document.getElementById('from-date').value;
    const toDate = document.getElementById('to-date').value;
    const url = getExportUrl(fromDate, toDate);

    // Initiate download
    window.location.href = url;

    // Restore button state after a short delay to simulate request completion
    setTimeout(() => setButtonState(exportButton, false), 3000);
}

function setButtonState(button, isLoading) {
    if (isLoading) {
        button.innerHTML = /*html*/`Generating... <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>`;
        button.style.cursor = 'not-allowed';
        button.style.backgroundColor = 'var(--accent-color-light)';
        button.style.color = 'var(--accent-invert-light)';
    } else {
        button.innerHTML = /*html*/`Generate <i class="material-icons" style="font-size: 20px; color: var(--accent-invert)">download</i>`;
        button.style.cursor = 'pointer';
        button.style.backgroundColor = 'var(--accent-color)';
        button.style.color = 'var(--accent-invert)';
    }
}

function getExportUrl(fromDate, toDate) {
    return `{% url 'dashboard:export-patient' patient.user.username %}?from=${encodeURIComponent(fromDate)}&to=${encodeURIComponent(toDate)}`;
}

</script>
{% endblock %}
