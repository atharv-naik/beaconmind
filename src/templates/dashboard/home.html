{% extends 'dashboard/base.html' %}

{% block header %}
Patient Assessments
{% endblock %}

{% block styles %}
<style>
    .item {
        cursor: pointer;
        background: linear-gradient(135deg, var(--item-bg), var(--content-bg));
        padding: 15px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }
</style>
{% endblock %}

{% block content %}
<div class="filter-sort" style="background-color: var(--content-bg); padding: 20px; border-radius: var(--item-border-radius); border-bottom: 1px solid var(--item-shadow)">
    <div class="row mb-4">
        <div class="col-md-4">
            <label for="filter-status" class="form-label" style="font-weight: bold; color: var(--text-color);">Filter by Status</label>
            <select id="filter-status" class="form-control" style="padding: 10px; background-color: var(--item-bg); color: var(--text-color); border: 1px solid var(--sidebar-border);">
                <option value="">All</option>
                <option value="pending">Pending</option>
                <option value="completed">Completed</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="filter-type" class="form-label" style="font-weight: bold; color: var(--text-color);">Filter by Type</label>
            <select id="filter-type" class="form-control" style="padding: 10px; background-color: var(--item-bg); color: var(--text-color); border: 1px solid var(--sidebar-border);">
                <option value="">All</option>
                {% for phase in phase_map.all %}
                <option value="{{ phase.name }}">{{ phase.verbose_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="sort-order" class="form-label" style="font-weight: bold; color: var(--text-color);">Sort by Date</label>
            <select id="sort-order" class="form-control" style="padding: 10px; background-color: var(--item-bg); color: var(--text-color); border: 1px solid var(--sidebar-border);">
                <option value="desc">Newest First</option>
                <option value="asc">Oldest First</option>
            </select>
        </div>
    </div>
    <div class="row mb-4">
        <div class="col-md-12">
            <label for="search-username" class="form-label" style="font-weight: bold; color: var(--text-color);">Search by Username</label>
            <input type="text" id="search-username" class="form-control" placeholder="Enter username" style="padding: 10px; background-color: var(--item-bg); color: var(--text-color); border: 1px solid var(--sidebar-border);">
        </div>
    </div>
</div>

<div id="assessments-list" class="assessments" style="margin: 20px 10px;">
    {% for assessment in assessments %}
    <div class="item mb-3" onclick="window.location.href='{% url 'dashboard:assessment' assessment.id %}'" data-status="{{ assessment.status }}" data-type="{{ assessment.type }}" data-timestamp="{{ assessment.timestamp|date:'U' }}" data-username="{{ assessment.patient.user.username|lower }}">
        <div>
            <h5 style="margin-bottom: 8px; font-size: 18px; color: var(--text-color);"><i class="material-icons" style="vertical-align: middle; margin-right: 8px; color: var(--text-color);">assignment</i>{{ assessment.patient.user.username }}'s {{ assessment.get_type_display }} Assessment</h5>
            <p style="margin: 0; font-size: 14px; color: var(--text-color);"><strong>Status:</strong> {{ assessment.status|capfirst }}</p>
            <p style="margin: 0; font-size: 14px; color: var(--text-color);">
                {% if assessment.status == 'completed' %}
                Completed {{ assessment.completed_at|timesince }} ago
                {% else %}
                Started {{ assessment.timestamp|timesince }} ago
                {% endif %}
            </p>
        </div>
    </div>
    {% endfor %}
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const filterStatus = document.getElementById('filter-status');
        const filterType = document.getElementById('filter-type');
        const sortOrder = document.getElementById('sort-order');
        const searchUsername = document.getElementById('search-username');
        const assessmentsList = document.getElementById('assessments-list');

        function applyFiltersAndSort() {
            const statusFilter = filterStatus.value;
            const typeFilter = filterType.value;
            const sort = sortOrder.value;
            const search = searchUsername.value.toLowerCase();

            const items = Array.from(assessmentsList.children);
            items.forEach(item => {
                const status = item.getAttribute('data-status');
                const type = item.getAttribute('data-type');
                const username = item.getAttribute('data-username');

                const show = 
                    (!statusFilter || status === statusFilter) &&
                    (!typeFilter || type === typeFilter) &&
                    (!search || username.includes(search));

                item.style.display = show ? 'block' : 'none';
            });

            items.sort((a, b) => {
                const timestampA = parseInt(a.getAttribute('data-timestamp'));
                const timestampB = parseInt(b.getAttribute('data-timestamp'));

                return sort === 'asc' ? timestampA - timestampB : timestampB - timestampA;
            });

            items.forEach(item => assessmentsList.appendChild(item));
        }

        filterStatus.addEventListener('change', applyFiltersAndSort);
        filterType.addEventListener('change', applyFiltersAndSort);
        sortOrder.addEventListener('change', applyFiltersAndSort);
        searchUsername.addEventListener('input', applyFiltersAndSort);

        applyFiltersAndSort();
    });
</script>
{% endblock %}
