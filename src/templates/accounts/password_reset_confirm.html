{% extends 'accounts/base.html' %}
{% load static %}

{% block title %}Forgot Password{% endblock %}

{% block extra_styles %}
    <style>

        @media screen and (max-width: 550px) {
            .container {
                min-width: unset;
                max-width: unset;
                aspect-ratio: unset;
            }
        }
        
    </style>
{% endblock %}

{% block content %}

<div class="container">
    <h2>Reset Your Password</h2>
    <form id="resetPasswordForm">
        {% csrf_token %}
        <div class="form-group">
            <div class="form-inline">
                <span class="material-icons icon left">lock</span>
                <input type="password" id="new_password1" name="new_password1" placeholder="New Password" required>
                <span class="material-icons icon right cursor-pointer toggle-password" onclick="togglePasswordVisibility(this)">visibility_off</span>
            </div>
            <div class="form-inline">
                <span class="material-icons icon left">lock</span>
                <input type="password" id="new_password2" name="new_password2" placeholder="Confirm New Password" required>
                <span class="material-icons icon right cursor-pointer toggle-password" onclick="togglePasswordVisibility(this)">visibility_off</span>
            </div>
            <p id="message"></p>
        </div>
        <button type="submit" id="submit-btn">Reset Password</button>
    </form>
</div>
{% endblock %}

{% block extra_scripts %}
    
    <script>
    document.getElementById("resetPasswordForm").addEventListener("submit", async function(event) {
        event.preventDefault(); // Prevent form from submitting the traditional way
    
        const newPassword1 = document.getElementById("new_password1").value;
        const newPassword2 = document.getElementById("new_password2").value;
        const messageElement = document.getElementById("message");
    
        if (newPassword1 !== newPassword2) {
            messageElement.textContent = "Passwords do not match!";
            messageElement.style.color = "red";
            return;
        }
    
        // Extract UID and token from the URL dynamically
        const urlParams = new URLSearchParams(window.location.search);
        const uidb64 = urlParams.get("uidb64");
        const token = urlParams.get("token");
    
        const response = await fetch(`{% url 'accounts:api-password-reset-confirm' uidb64=uidb64 token=token %}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": "{{ csrf_token }}",
            },
            body: JSON.stringify({ 
                new_password1: newPassword1,
                new_password2: newPassword2,
            })
        });
    
        const data = await response.json();
        if (response.ok) {
            messageElement.textContent = "Password has been reset successfully!";
            messageElement.style.color = "green";

            setTimeout(() => {
                window.location.href = "{% url 'accounts:login' %}";
            }, 2000);
        } else {
            messageElement.textContent = data.error || "Something went wrong.";
            messageElement.style.color = "red";
        }
    });


    const togglePasswordVisibility = (element) => {
        const input = element.previousElementSibling;
        if (input.type === "password") {
            input.type = "text";
            element.textContent = "visibility";
        } else {
            input.type = "password";
            element.textContent = "visibility_off";
        }
    };

    </script>
{% endblock %}
